# -*- coding: utf-8 -*-

from __future__ import print_function
import sys
import os
import logging
import click
import subprocess
import re
import datetime
from .cmd import cli
from .daylog import DAYLOG
import oam.settings

class ServersLog(object):
    """Name/open normal-log and error-log files"""

    LOGROOT = oam.settings.oam.logs.directory
    HOSTNAME = os.uname()[1]

    def __init__(self, default_logname = 'unknown'):
        self.logger = logging.getLogger("oam.serverslog")
        self.daydir = '{}/{}'.format(self.LOGROOT, DAYLOG.current_day())
        self.logname = default_logname

    def hostdir(self, host):
        if host == None:
            host = self.HOSTNAME
        dirname = '{}/{}'.format(self.daydir, host)
        if not os.path.isdir(dirname):
            os.makedirs(dirname)
        return dirname

    def set_logname(self, logname):
        self.logname = logname

    def out(self, host=None):
        return open('{}/{}.log'.format(self.hostdir(host), self.logname), 'a')

    def err(self, host=None):
        return open('{}/error-{}.log'.format(self.hostdir(host), self.logname), 'a')

    def fail(self, host, result):
        self.logger.error('%s %s %s', host, str(result.result_code), result.stderr)
        return 1
